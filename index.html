<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BiBank | Premium Banking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* BiBank Branding & Glassmorphism */
        :root { --bibank-green: #00875A; }
        body { background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%); color: #1f2937; }
        .glass { background: rgba(255, 255, 255, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.5); }
        .bg-emerald { background-color: var(--bibank-green); }
        .text-emerald { color: var(--bibank-green); }
        
        /* 3D Card Flip CSS */
        .perspective { perspective: 1000px; }
        .preserve-3d { transform-style: preserve-3d; transition: transform 0.6s; }
        .backface-hidden { backface-visibility: hidden; }
        .rotate-y-180 { transform: rotateY(180deg); }
        .card-container:hover .preserve-3d { transform: rotateY(180deg); }

        /* Toast Animations */
        @keyframes slideIn { from { transform: translateY(-100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .toast-animate { animation: slideIn 0.3s ease-out forwards; }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-6">

    <div id="toast-container" class="fixed top-5 right-5 z-50 flex flex-col gap-2"></div>

    <div id="auth-view" class="glass rounded-2xl p-8 w-full max-w-md shadow-2xl transition-all duration-500">
        <h1 class="text-3xl font-bold text-center mb-2 text-emerald">BiBank</h1>
        <p class="text-center text-gray-500 mb-6">Enter your Card Number to continue</p>
        
        <input id="auth-card" type="text" placeholder="Card Number (e.g., 12345678)" class="w-full p-3 rounded-lg border border-gray-300 mb-4 focus:outline-none focus:ring-2 focus:ring-[#00875A]">
        <input id="auth-pin" type="password" placeholder="4-Digit PIN" class="w-full p-3 rounded-lg border border-gray-300 mb-6 focus:outline-none focus:ring-2 focus:ring-[#00875A]">
        
        <button id="btn-login" class="w-full bg-emerald text-white p-3 rounded-lg font-semibold hover:bg-[#006b47] transition">Login</button>
        <button id="btn-register" class="w-full mt-3 bg-gray-200 text-gray-700 p-3 rounded-lg font-semibold hover:bg-gray-300 transition">Create Account</button>
    </div>

    <div id="dashboard-view" class="hidden w-full max-w-5xl grid grid-cols-1 md:grid-cols-3 gap-6 transition-all duration-500">
        
        <div class="md:col-span-1 space-y-6">
            <div class="glass rounded-2xl p-6 shadow-xl">
                <h2 class="text-gray-500 text-sm font-semibold uppercase tracking-wider">Total Balance</h2>
                <h1 id="display-balance" class="text-4xl font-bold text-gray-900 mt-2">$0.00</h1>
                <p id="user-greeting" class="text-sm text-gray-400 mt-1">Welcome back</p>
                <button id="btn-logout" class="mt-4 text-xs text-red-500 border border-red-500 px-3 py-1 rounded hover:bg-red-500 hover:text-white transition">Logout</button>
            </div>

            <div class="card-container perspective w-full h-48 cursor-pointer">
                <div class="preserve-3d relative w-full h-full">
                    <div class="absolute w-full h-full backface-hidden bg-gradient-to-br from-[#00875A] to-gray-900 text-white rounded-2xl p-5 shadow-lg flex flex-col justify-between">
                        <div class="flex justify-between items-center">
                            <span class="font-bold text-lg tracking-widest">BiBank</span>
                            <svg class="w-8 h-8 opacity-70" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                        </div>
                        <div>
                            <p id="card-display-number" class="text-xl tracking-widest font-mono mb-1">**** **** **** ****</p>
                            <p class="text-xs uppercase opacity-80">Virtual Debit</p>
                        </div>
                    </div>
                    <div class="absolute w-full h-full backface-hidden rotate-y-180 bg-gray-800 text-white rounded-2xl shadow-lg">
                        <div class="w-full h-10 bg-black mt-4"></div>
                        <div class="p-4 flex justify-end">
                            <div class="bg-white text-black p-1 px-3 rounded text-sm font-mono">CVV: 123</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="md:col-span-2 space-y-6">
            
            <div class="glass rounded-2xl p-6 shadow-xl flex gap-4 items-end">
                <div class="flex-1">
                    <label class="text-sm text-gray-500">Transfer To (Card No)</label>
                    <input id="tx-recipient" type="text" class="w-full mt-1 p-2 rounded border border-gray-300 focus:outline-none focus:border-[#00875A]">
                </div>
                <div class="w-32">
                    <label class="text-sm text-gray-500">Amount ($)</label>
                    <input id="tx-amount" type="number" class="w-full mt-1 p-2 rounded border border-gray-300 focus:outline-none focus:border-[#00875A]">
                </div>
                <button id="btn-transfer" class="bg-emerald text-white px-6 py-2 rounded font-semibold hover:bg-[#006b47] transition mb-[1px]">Send</button>
            </div>

            <div class="glass rounded-2xl p-6 shadow-xl">
                <h3 class="font-bold text-gray-700 mb-4">Spending Analytics</h3>
                <canvas id="spendingChart" height="80"></canvas>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDocY29uc3QgZmlyZWJhc2VDb25maWcgPSB7CsKgIGFwaUtleTogIkFJemFTeURKaEJ0a0tpeWVINWJPSFg3Qi1xLUJVcFFQYjRGWnZURSIsCsKgIGF1dGhEb21haW46ICJiaWJhbmsxLmZpcmViYXNlYXBwLmNvbSIsCsKgIHByb2plY3RJZDogImJpYmFuazEiLArCoCBzdG9yYWdlQnVja2V0OiAiYmliYW5rMS5maXJlYmFzZXN0b3JhZ2UuYXBwIiwKwqAgbWVzc2FnaW5nU2VuZGVySWQ6ICIyNzA3OTQ2MTQyMjkiLArCoCBhcHBJZDogIjE6MjcwNzk0NjE0MjI5OndlYjpmOTRlOTdkYzRiNTkyZjlmNDQ4OTVjIiwKwqAgbWVhc3VyZW1lbnRJZDogIkctREVUVDI0RTAyTSIKfTs=, onSnapshot, runTransaction, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";

        // CREDENTIAL OBFUSCATION (Replace with your actual base64 encoded config)
        // e.g. btoa(JSON.stringify({ apiKey: "...", projectId: "..." }))
        const b64Config = "Y29uc3QgZmlyZWJhc2VDb25maWcgPSB7CsKgIGFwaUtleTogIkFJemFTeURKaEJ0a0tpeWVINWJPSFg3Qi1xLUJVcFFQYjRGWnZURSIsCsKgIGF1dGhEb21haW46ICJiaWJhbmsxLmZpcmViYXNlYXBwLmNvbSIsCsKgIHByb2plY3RJZDogImJpYmFuazEiLArCoCBzdG9yYWdlQnVja2V0OiAiYmliYW5rMS5maXJlYmFzZXN0b3JhZ2UuYXBwIiwKwqAgbWVzc2FnaW5nU2VuZGVySWQ6ICIyNzA3OTQ2MTQyMjkiLArCoCBhcHBJZDogIjE6MjcwNzk0NjE0MjI5OndlYjpmOTRlOTdkYzRiNTkyZjlmNDQ4OTVjIiwKwqAgbWVhc3VyZW1lbnRJZDogIkctREVUVDI0RTAyTSI="; // Dummy base64 for {"projectId":"mock-bibank"}
        
        let app, auth, db;
        try {
            const firebaseConfig = JSON.parse(atob(b64Config));
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch(e) { console.error("Firebase init failed due to invalid config."); }

        // UI Elements
        const authView = document.getElementById('auth-view');
        const dashboardView = document.getElementById('dashboard-view');
        let currentUserDocRef = null;

        // Toast Notification System
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast-animate px-4 py-3 rounded-lg shadow-lg text-white text-sm font-semibold ${type === 'success' ? 'bg-emerald' : 'bg-red-500'}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.remove(); }, 3000);
        }

        // Auth Mock Logic (Mapping Card Number to an Email for Firebase Auth)
        const formatEmail = (card) => `${card}@bibank.mock`;

        document.getElementById('btn-login').addEventListener('click', async () => {
            const card = document.getElementById('auth-card').value;
            const pin = document.getElementById('auth-pin').value;
            try {
                await signInWithEmailAndPassword(auth, formatEmail(card), pin);
                showToast("Login Successful!");
            } catch (error) { showToast("Invalid Card or PIN", "error"); }
        });

        document.getElementById('btn-register').addEventListener('click', async () => {
            const card = document.getElementById('auth-card').value;
            const pin = document.getElementById('auth-pin').value;
            try {
                const userCred = await createUserWithEmailAndPassword(auth, formatEmail(card), pin);
                await setDoc(doc(db, "users", userCred.user.uid), {
                    cardNo: card, balance: 0.00, role: "User", isFrozen: false, createdAt: serverTimestamp()
                });
                showToast("Account Created!");
            } catch (error) { showToast("Error creating account", "error"); }
        });

        document.getElementById('btn-logout').addEventListener('click', () => signOut(auth));

        // Persistence & Real-time updates
        onAuthStateChanged(auth, (user) => {
            if (user) {
                authView.classList.add('hidden');
                dashboardView.classList.remove('hidden');
                currentUserDocRef = doc(db, "users", user.uid);
                
                // Real-time Balance Snapshot
                onSnapshot(currentUserDocRef, (docSnap) => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('display-balance').innerText = `$${parseFloat(data.balance).toFixed(2)}`;
                        document.getElementById('card-display-number').innerText = data.cardNo.replace(/(.{4})/g, '$1 ').trim();
                        if(data.isFrozen) showToast("Account Frozen by Admin", "error");
                    }
                });
            } else {
                authView.classList.remove('hidden');
                dashboardView.classList.add('hidden');
            }
        });

        // Atomic P2P Transfer Logic
        document.getElementById('btn-transfer').addEventListener('click', async () => {
            if(!auth.currentUser) return;
            const recipientCard = document.getElementById('tx-recipient').value;
            const amount = parseFloat(document.getElementById('tx-amount').value);

            if (!amount || amount <= 0) return showToast("Enter a valid amount", "error");

            try {
                await runTransaction(db, async (transaction) => {
                    // 1. Read sender doc
                    const senderDoc = await transaction.get(currentUserDocRef);
                    if (!senderDoc.exists() || senderDoc.data().isFrozen) throw "Account frozen or unavailable";
                    
                    const newBalance = senderDoc.data().balance - amount;
                    if (newBalance < 0) throw "Insufficient funds";

                    // 2. Find recipient via query (mocked lookup for simplicity, in reality use a Cloud Function)
                    // Note: Firestore runTransaction requires all reads before writes. 
                    // Assuming we have recipient UID mapped or available. For this frontend mock, we will 
                    // simulate the transfer. In production, NEVER do client-side recipient lookups for tx.
                    
                    transaction.update(currentUserDocRef, { balance: newBalance });
                    // Log transaction
                    const txRef = doc(collection(db, "transactions"));
                    transaction.set(txRef, {
                        senderId: auth.currentUser.uid, amount: amount, timestamp: serverTimestamp()
                    });
                });
                showToast(`Transferred $${amount} successfully!`);
                document.getElementById('tx-amount').value = '';
            } catch (e) {
                showToast(e.toString(), "error");
            }
        });

        // Initialize Chart.js
        const ctx = document.getElementById('spendingChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                datasets: [{
                    label: 'Spending ($)', data: [12, 19, 3, 5, 2, 30, 45],
                    borderColor: '#00875A', backgroundColor: 'rgba(0, 135, 90, 0.1)',
                    tension: 0.4, fill: true
                }]
            },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true } } }
        });
    </script>
</body>
</html>
