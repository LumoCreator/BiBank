<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BiBank</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #FF6B00;
            --bg: #0D0D0D;
            --surface: #1C1C1E;
            --text: #FFFFFF;
            --text-sec: #8E8E93;
            --danger: #FF453A;
            --radius: 16px;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif; overflow: hidden; height: 100vh; }

        .hidden { display: none !important; }
        .flex-center { display: flex; justify-content: center; align-items: center; }
        .screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; padding: 20px; overflow-y: auto; padding-bottom: 90px; background: var(--bg); transition: opacity 0.3s; }
        
        h1 { font-size: 28px; font-weight: 700; margin-bottom: 10px; }
        h2 { font-size: 20px; font-weight: 600; margin-bottom: 15px; }
        p { color: var(--text-sec); font-size: 14px; margin-top: 0; }

        .input-group { margin-bottom: 15px; width: 100%; }
        input, select {
            width: 100%; background: var(--surface); border: 1px solid transparent;
            padding: 16px; border-radius: 12px; color: var(--text); font-size: 16px; outline: none; transition: 0.2s;
        }
        input:focus { border-color: var(--primary); }
        
        .btn {
            width: 100%; padding: 16px; border-radius: 12px; border: none;
            background: var(--primary); color: white; font-weight: 600; font-size: 16px;
            cursor: pointer; position: relative; overflow: hidden; transition: 0.2s;
        }
        .btn.loading { color: transparent; pointer-events: none; }
        .btn.loading::after {
            content: ""; position: absolute; top: 50%; left: 50%; width: 20px; height: 20px;
            border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
            border-radius: 50%; animation: spin 0.8s linear infinite; margin-top: -10px; margin-left: -10px;
        }

        .bank-card {
            background: linear-gradient(135deg, #FF6B00 0%, #FF8F40 100%); border-radius: 20px; padding: 25px; height: 200px; position: relative;
            color: white; box-shadow: 0 10px 30px rgba(255, 107, 0, 0.2); margin-bottom: 25px;
        }
        .card-bal { font-size: 32px; font-weight: 700; margin-top: 30px; }
        .card-bottom { display: flex; justify-content: space-between; position: absolute; bottom: 25px; left: 25px; right: 25px; font-family: monospace; font-size: 16px; }

        .tx-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid #2C2C2E; }
        .tx-amount.plus { color: #32D74B; }

        .nav-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 80px;
            background: rgba(28, 28, 30, 0.95); backdrop-filter: blur(10px);
            display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #2C2C2E; z-index: 100;
        }
        .nav-item { display: flex; flex-direction: column; align-items: center; color: var(--text-sec); font-size: 10px; cursor: pointer; }
        .nav-item.active { color: var(--primary); }

        #chat-messages { height: calc(100vh - 220px); overflow-y: auto; margin-bottom: 15px; display: flex; flex-direction: column; }
        .msg { max-width: 80%; padding: 12px 16px; border-radius: 16px; margin-bottom: 10px; font-size: 14px; line-height: 1.4; }
        .msg.user { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 4px; }
        .msg.ai { background: var(--surface); color: var(--text); border-bottom-left-radius: 4px; align-self: flex-start; }

        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #toast { position: fixed; top: 40px; left: 50%; transform: translateX(-50%); background: var(--surface); padding: 12px 24px; border-radius: 30px; border: 1px solid var(--primary); opacity: 0; transition: 0.3s; z-index: 1000; font-size: 14px; }
        #toast.show { opacity: 1; }
    </style>
</head>
<body>

    <div id="toast">Готово</div>

    <div id="screen-login" class="screen flex-center" style="flex-direction: column; z-index: 50;">
        <h1 style="color: var(--primary); font-size: 40px;">BiBank</h1>
        <div class="input-group"><input type="email" id="login-email" placeholder="Email"></div>
        <div class="input-group"><input type="password" id="login-pass" placeholder="Пароль"></div>
        <button class="btn" onclick="handleLogin(this)">Войти</button>
        <button class="btn" style="background:none; color:var(--primary); margin-top:10px;" onclick="nav('screen-register')">Регистрация</button>
    </div>

    <div id="screen-register" class="screen hidden flex-center" style="flex-direction: column; z-index: 50;">
        <h2>Регистрация</h2>
        <div class="input-group"><input type="text" id="reg-name" placeholder="Имя"></div>
        <div class="input-group"><input type="email" id="reg-email" placeholder="Email"></div>
        <div class="input-group"><input type="password" id="reg-pass" placeholder="Пароль"></div>
        <button class="btn" onclick="handleRegister(this)">Создать аккаунт</button>
        <button class="btn" style="background:none; color:var(--primary); margin-top:10px;" onclick="nav('screen-login')">Назад</button>
    </div>

    <div id="screen-pin" class="screen hidden flex-center" style="flex-direction: column; z-index: 50;">
        <h2>PIN-код</h2>
        <div class="input-group"><input type="tel" id="pin-input" placeholder="XXXX" maxlength="4" style="text-align: center; letter-spacing: 10px;"></div>
        <button class="btn" onclick="handlePinSet(this)">Подтвердить</button>
    </div>

    <div id="main-app-container" class="hidden">
        <div id="screen-home" class="screen">
            <h1>Мои карты</h1>
            <div id="card-container"></div>
            <h2>История</h2>
            <div id="tx-history"></div>
        </div>

        <div id="screen-pay" class="screen hidden">
            <h1>Перевод</h1>
            <div class="input-group"><select id="pay-from-card"></select></div>
            <div class="input-group"><input type="text" id="pay-to" placeholder="Email получателя"></div>
            <div class="input-group"><input type="number" id="pay-amount" placeholder="Сумма"></div>
            <button class="btn" onclick="handleTransfer(this)">Отправить</button>
        </div>

        <div id="screen-chat" class="screen hidden">
            <h1>Помощник</h1>
            <div id="chat-messages"></div>
            <div style="position: fixed; bottom: 90px; left: 20px; right: 20px; display: flex; gap: 10px;">
                <input type="text" id="chat-input" placeholder="Спроси о балансе...">
                <button class="btn" style="width: 50px;" onclick="handleChat(this)"><i class="fa-solid fa-paper-plane"></i></button>
            </div>
        </div>

        <div id="screen-issue" class="screen hidden flex-center" style="flex-direction:column">
            <h1>Выпустить карту</h1>
            <button class="btn" onclick="handleIssueCard(this)">Создать виртуальную карту</button>
        </div>

        <div class="nav-bar">
            <div class="nav-item active" onclick="navTab('screen-home', this)"><i class="fa-solid fa-wallet"></i><span>Главная</span></div>
            <div class="nav-item" onclick="navTab('screen-pay', this)"><i class="fa-solid fa-paper-plane"></i><span>Платежи</span></div>
            <div class="nav-item" onclick="navTab('screen-chat', this)"><i class="fa-solid fa-robot"></i><span>AI</span></div>
            <div class="nav-item" onclick="navTab('screen-issue', this)"><i class="fa-solid fa-plus"></i><span>Карта</span></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, doc, setDoc, onSnapshot, query, orderBy, increment, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

        const firebaseConfig = {
            apiKey: "AIzaSyC1f33BCIiSV6JL9HMquLmTgy74NJz8HJ8",
            authDomain: "bibankk.firebaseapp.com",
            projectId: "bibankk",
            storageBucket: "bibankk.firebasestorage.app",
            messagingSenderId: "150022541822",
            appId: "1:150022541822:web:7f314ae78fad29477eb0af"
        };
        
        const GEMINI_API_KEY = "AIzaSyADzqXLgXAJTdvnKJh3STswUViEuAgL0fQ";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- СТАБИЛЬНЫЙ AI ---
        const genAI = new GoogleGenerativeAI(GEMINI_API_KEY);
        const model = genAI.getGenerativeModel({ model: "gemini-1.5-flash" }, { apiVersion: "v1" });
        
        let currentUser = null;
        let userCards = [];

        window.nav = (id) => {
            document.querySelectorAll('.screen').forEach(s => s.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        };

        window.navTab = (id, el) => {
            nav(id);
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            el.classList.add('active');
            if(id === 'screen-pay') loadCardsForPay();
        };

        window.toast = (m) => {
            const t = document.getElementById('toast');
            t.innerText = m; t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        };

        async function protectBtn(btn, action) {
            btn.classList.add('loading');
            try { await action(); } catch(e) { toast(e.message); }
            finally { btn.classList.remove('loading'); }
        }

        onAuthStateChanged(auth, (u) => {
            if (u) {
                currentUser = u;
                if(sessionStorage.getItem('bibank_pin')) initApp();
                else nav('screen-pin');
            } else nav('screen-login');
        });

        window.handleLogin = (btn) => protectBtn(btn, async () => {
            await signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-pass').value);
        });

        window.handleRegister = (btn) => protectBtn(btn, async () => {
            const email = document.getElementById('reg-email').value;
            const cred = await createUserWithEmailAndPassword(auth, email, document.getElementById('reg-pass').value);
            await setDoc(doc(db, "users", cred.user.uid), { name: document.getElementById('reg-name').value, email });
            await createCard(cred.user.uid, 10000);
        });

        window.handlePinSet = (btn) => protectBtn(btn, async () => {
            if(document.getElementById('pin-input').value.length === 4) {
                sessionStorage.setItem('bibank_pin', '1');
                initApp();
            }
        });

        function initApp() {
            nav('screen-home');
            document.getElementById('main-app-container').classList.remove('hidden');
            
            onSnapshot(query(collection(db, `users/${currentUser.uid}/cards`)), (s) => {
                userCards = [];
                const container = document.getElementById('card-container');
                container.innerHTML = '';
                s.forEach(d => {
                    const data = d.data();
                    userCards.push({id: d.id, ...data});
                    container.innerHTML += `<div class="bank-card"><div class="card-bal">${data.balance} ₽</div><div class="card-bottom"><span>**** ${data.number.slice(-4)}</span></div></div>`;
                });
            });

            onSnapshot(query(collection(db, `users/${currentUser.uid}/transactions`), orderBy('date', 'desc')), (s) => {
                const h = document.getElementById('tx-history');
                h.innerHTML = '';
                s.forEach(d => {
                    const t = d.data();
                    h.innerHTML += `<div class="tx-item"><span>${t.title}</span><span class="${t.type==='in'?'plus':''}">${t.type==='in'?'+':'-'}${t.amount} ₽</span></div>`;
                });
            });
        }

        async function createCard(uid, bal) {
            const num = "4276" + Math.floor(Math.random() * 1000000000000);
            await addDoc(collection(db, `users/${uid}/cards`), { number: num, balance: bal, color: '#FF6B00' });
        }

        function loadCardsForPay() {
            document.getElementById('pay-from-card').innerHTML = userCards.map(c => `<option value="${c.id}">*${c.number.slice(-4)} (${c.balance} ₽)</option>`).join('');
        }

        window.handleTransfer = (btn) => protectBtn(btn, async () => {
            const amount = parseFloat(document.getElementById('pay-amount').value);
            const fromId = document.getElementById('pay-from-card').value;
            await runTransaction(db, async (tx) => {
                tx.update(doc(db, `users/${currentUser.uid}/cards/${fromId}`), { balance: increment(-amount) });
                tx.set(doc(collection(db, `users/${currentUser.uid}/transactions`)), { title: "Перевод", amount, type: "out", date: serverTimestamp() });
            });
            toast("Успешно!");
        });

        window.handleIssueCard = (btn) => protectBtn(btn, async () => {
            await createCard(currentUser.uid, 0);
            toast("Карта создана");
            navTab('screen-home', document.querySelector('.nav-item'));
        });

        // --- ЧАТ (ГЛАВНОЕ ИСПРАВЛЕНИЕ) ---
        window.handleChat = (btn) => protectBtn(btn, async () => {
            const input = document.getElementById('chat-input');
            const chatBox = document.getElementById('chat-messages');
            const text = input.value;
            if(!text) return;

            chatBox.innerHTML += `<div class="msg user">${text}</div>`;
            input.value = '';

            const context = `Данные клиента: ${userCards.map(c => c.balance + 'р').join(', ')}. Отвечай кратко.`;
            
            try {
                // Прямой запрос без лишних настроек для стабильности
                const result = await model.generateContent(context + " Вопрос: " + text);
                chatBox.innerHTML += `<div class="msg ai">${result.response.text()}</div>`;
            } catch(e) {
                chatBox.innerHTML += `<div class="msg ai" style="color:var(--danger)">Ошибка сети. Включите VPN.</div>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        });
    </script>
</body>
</html>
